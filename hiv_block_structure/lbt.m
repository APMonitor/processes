clc; clear all; close all

nzd = 840; % non-zeros along diagonal
nb = 180; % number of blocks
nbmax = 12; % max block size
nbmin = 1; % min block size

% original sparsity pattern
load apm_jac.txt
fs = apm_jac;
logicvec = ones(size(fs(:,1)));
ss = sparse(fs(:,1),fs(:,2),logicvec,nzd,nzd);
ss = sparse(fs(:,1),fs(:,2),fs(:,3),nzd,nzd);
sf = full(ss);

% modified sparsity pattern
v = [ 7 485 483 486 5 6 484 481 482 3 2 1 4 8 13 492 489 491 15 14 490 487 488 11 10 9 12 16 23 497 494 19 18 495 498 21 22 496 493 17 20 24 31 26 27 503 500 501 504 29 30 502 499 25 28 32 35 505 506 508 38 37 39 510 509 507 34 33 36 40 516 43 42 513 515 47 46 45 512 514 511 41 44 48 51 50 518 519 522 521 53 55 54 520 517 49 52 56 528 525 527 63 61 62 526 523 524 59 58 57 60 64 534 67 66 530 531 533 71 69 70 532 529 65 68 72 75 535 536 78 538 77 79 540 539 537 74 73 76 80 83 82 542 543 545 87 546 85 86 544 541 81 84 88 93 549 552 551 95 94 550 547 548 91 90 89 92 96 553 555 557 103 558 102 556 101 554 99 98 97 100 104 111 106 107 563 109 560 561 564 110 562 559 105 108 112 565 570 567 569 119 118 568 117 566 115 114 113 116 120 127 122 123 575 573 576 126 125 572 574 571 121 124 128 135 581 579 582 133 134 580 577 578 131 130 129 132 136 588 139 587 141 143 142 586 583 584 585 138 137 140 144 147 589 590 592 150 149 151 594 593 591 146 145 148 152 597 154 157 596 155 599 159 600 158 598 595 153 156 160 163 162 603 606 605 167 166 165 602 604 601 161 164 168 607 171 611 175 612 174 610 173 608 609 170 169 172 176 613 615 617 183 618 182 616 181 614 179 178 177 180 184 191 620 186 187 623 621 624 189 190 622 619 185 188 192 630 627 629 197 199 198 628 625 626 195 194 193 196 200 203 631 632 634 206 205 207 636 635 633 202 201 204 208 642 211 210 639 641 215 214 213 638 640 637 209 212 216 645 648 647 221 223 222 646 643 644 219 218 217 220 224 231 653 227 226 651 654 230 229 650 652 649 225 228 232 660 235 659 239 237 238 658 655 656 657 234 233 236 240 243 661 662 664 246 245 247 666 665 663 242 241 244 248 668 669 250 251 671 253 255 672 254 670 667 249 252 256 261 675 678 677 263 262 676 673 674 259 258 257 260 264 684 681 683 269 271 270 682 679 680 267 266 265 268 272 275 274 686 687 690 689 279 277 278 688 685 273 276 280 285 283 695 287 696 286 694 691 692 693 282 281 284 288 702 699 290 698 291 701 295 293 294 700 697 289 292 296 708 705 298 299 707 303 302 301 704 706 703 297 300 304 307 306 710 711 713 309 311 714 310 712 709 305 308 312 715 720 319 318 718 317 716 315 719 717 314 313 316 320 726 723 322 722 323 725 325 327 326 724 721 321 324 328 335 731 331 330 728 729 732 333 334 730 727 329 332 336 339 737 343 738 341 342 736 733 734 735 338 337 340 344 739 742 347 744 743 351 350 349 740 741 346 345 348 352 359 354 355 749 747 750 358 357 746 748 745 353 356 360 363 362 752 753 755 365 367 756 366 754 751 361 364 368 757 760 762 375 374 373 758 371 761 759 370 369 372 376 768 765 378 764 379 767 383 381 382 766 763 377 380 384 774 770 771 386 387 773 389 391 390 772 769 385 388 392 395 779 397 399 780 398 778 775 776 777 394 393 396 400 781 786 783 785 407 406 784 405 782 403 402 401 404 408 792 413 415 414 790 787 788 411 791 789 410 409 412 416 423 797 421 794 419 418 795 798 422 796 793 417 420 424 427 799 800 430 802 429 431 804 803 801 426 425 428 432 806 435 434 807 809 437 439 810 438 808 805 433 436 440 443 442 813 816 815 447 446 445 812 814 811 441 444 448 453 451 821 455 822 454 820 817 818 819 450 449 452 456 459 458 824 825 827 461 463 828 462 826 823 457 460 464 471 833 467 466 831 834 470 469 830 832 829 465 468 472 475 474 477 836 837 839 479 840 478 838 835 473 476 480];
e = [ 7 483 486 6 482 5 481 1 484 485 2 3 4 8 13 14 491 15 492 490 487 488 489 10 11 9 12 16 498 495 496 497 19 18 22 494 23 21 17 493 20 24 31 26 503 501 27 504 30 29 502 499 500 25 28 32 34 506 507 505 508 37 38 509 39 510 33 35 36 40 515 43 41 42 513 516 46 47 514 45 512 511 44 48 50 51 520 522 521 519 518 55 54 53 517 49 52 56 527 528 525 62 524 63 61 57 526 58 59 523 60 64 70 67 66 531 533 71 534 530 532 69 529 65 68 72 74 536 538 78 535 77 79 539 537 540 75 73 76 80 545 83 543 82 87 546 86 542 544 85 541 81 84 88 95 552 551 549 94 93 547 548 550 90 89 91 92 96 97 557 103 558 102 101 553 554 556 99 555 98 100 104 564 106 107 111 560 561 563 110 562 109 559 105 108 112 566 118 569 119 570 568 565 117 567 114 115 113 116 120 127 123 122 573 576 575 126 572 574 125 121 571 124 128 582 579 581 134 133 135 577 578 580 131 130 129 132 136 142 139 585 143 588 141 583 584 586 587 137 138 140 144 147 590 591 149 592 150 594 593 151 146 145 589 148 152 599 153 596 597 154 159 600 158 598 157 595 155 156 160 163 161 162 605 603 606 167 166 604 165 602 601 164 168 607 171 609 612 174 175 173 608 610 611 170 169 172 176 613 617 183 618 182 616 181 614 615 179 178 177 180 184 624 621 187 186 191 623 190 620 622 189 185 619 188 192 629 630 199 197 198 628 625 626 627 194 193 195 196 200 203 632 634 631 205 206 636 635 207 202 633 201 204 208 641 211 210 642 639 215 214 638 640 213 637 209 212 216 647 222 223 221 648 646 643 644 645 218 219 217 220 224 654 651 653 227 226 230 231 229 652 649 650 225 228 232 238 235 239 660 237 658 655 656 657 659 234 233 236 240 242 662 664 661 245 247 246 665 663 666 241 243 244 248 669 671 251 250 255 668 672 254 670 253 667 249 252 256 261 678 677 263 262 676 673 674 675 258 259 257 260 264 270 683 681 271 684 682 269 680 267 266 265 679 268 272 275 274 687 690 689 279 278 686 688 277 685 273 276 280 285 283 287 696 695 286 691 692 694 282 693 281 284 288 701 290 699 700 291 295 702 294 293 697 698 289 292 296 302 708 299 707 705 303 301 704 706 703 297 298 300 304 307 305 711 713 311 309 714 310 712 709 710 306 308 312 715 719 319 318 317 716 718 315 717 720 314 313 316 320 326 725 723 323 322 327 325 726 724 721 722 321 324 328 732 335 731 331 729 330 334 728 730 333 329 727 332 336 737 343 738 342 341 736 733 734 735 338 339 337 340 344 739 349 347 743 351 350 742 740 741 744 345 346 348 352 359 354 749 747 750 358 357 746 748 745 353 355 356 360 362 361 754 755 753 367 756 366 365 751 752 363 364 368 757 373 761 374 375 758 760 371 759 762 370 369 372 376 382 768 378 379 767 765 383 381 766 763 764 377 380 384 390 772 774 387 773 771 770 391 389 769 385 386 388 392 779 777 399 780 398 397 775 776 778 394 395 393 396 400 781 785 786 407 406 784 405 782 783 402 401 403 404 408 791 413 414 415 787 788 790 411 789 792 409 410 412 416 423 795 421 796 419 418 798 797 422 793 794 417 420 424 426 799 802 430 429 800 431 803 801 804 427 425 428 432 807 434 435 809 439 806 810 438 808 437 433 805 436 440 443 441 442 815 813 816 447 446 814 445 812 811 444 448 455 821 819 822 454 453 817 818 820 450 449 451 452 456 459 457 825 827 463 824 828 462 826 461 823 458 460 464 471 831 833 467 834 470 469 830 832 829 465 466 468 472 475 474 836 837 839 479 840 478 838 477 473 835 476 480];
sb = [ 1 13 14 15 27 28 29 41 42 43 55 56 57 69 70 71 83 84 85 97 98 99 111 112 113 125 126 127 139 140 141 153 154 155 167 168 169 181 182 183 195 196 197 209 210 211 223 224 225 237 238 239 251 252 253 265 266 267 279 280 281 293 294 295 307 308 309 321 322 323 335 336 337 349 350 351 363 364 365 377 378 379 391 392 393 405 406 407 419 420 421 433 434 435 447 448 449 461 462 463 475 476 477 489 490 491 503 504 505 517 518 519 531 532 533 545 546 547 559 560 561 573 574 575 587 588 589 601 602 603 615 616 617 629 630 631 643 644 645 657 658 659 671 672 673 685 686 687 699 700 701 713 714 715 727 728 729 741 742 743 755 756 757 769 770 771 783 784 785 797 798 799 811 812 813 825 826 827 839 840];

% modified matrix
sm1 = sf;
sm2 = zeros(size(sm1));
sm3 = sm2;
for i = 1:nzd,
    sm2(i,:) = sm1(v(i),:);
end
for i = 1:nzd,
    sm3(:,i) = sm2(:,e(i));
end

[x1,y1] = find(sm1);
[x3,y3] = find(sm3);

figure(1)
subplot(1,2,1)
spy(ss)
subplot(1,2,2)
spy(sm3)

figure(2)
subplot(1,2,1)
scatter(x1,y1,3,'bd')
set(gca,'YDir','rev')
ylabel('Variable')
xlabel('Equation')
axis([0 nzd 0 nzd])
text(100,50,'Original')
text(150,100,'Sparsity')


subplot(1,2,2)
hold on
text(100,50,'Lower Block')
text(150,100,'Triangular')
text(200,150,'Form')
for i = 1:size(sb,2),
    if i<=9,
        plot([sb(i) sb(i)],[0 sb(i)],'k-','LineWidth',1)
    end
    plot([0 sb(i)],[sb(i) sb(i)],'k-','LineWidth',1)
end
scatter(x3,y3,2,'rd')
xlabel('Equation')
set(gca,'YDir','rev')
axis([0 nzd 0 nzd])

% Add another set of axes
h1 = axes('Position', [0.75 0.6 0.15 0.3]);
hold on
for i = 1:size(sb,2),
    plot([sb(i) sb(i)],[0 sb(i)],'k-','LineWidth',1)
    plot([0 sb(i)],[sb(i) sb(i)],'k-','LineWidth',1)
end
scatter(x3,y3,3,'rd')
set(gca,'YDir','rev')
axis([0 43 0 43])

% Add another set of axes
h2 = axes('Position', [0.27 0.37 0.1 0.2]);
hold on
scatter(x1,y1,3,'bd')
set(gca,'YDir','rev')
axis([400 420 400 420])

% Add another set of axes
h3 = axes('Position', [0.35 0.62 0.1 0.2]);
hold on
scatter(x1,y1,3,'bd')
set(gca,'YDir','rev')
axis([630 650 200 220])

% Add another set of axes
h4 = axes('Position', [0.21 0.17 0.07 0.14]);
hold on
scatter(x1,y1,3,'bd')
set(gca,'YDir','rev')
axis([200 220 630 650])
